-- Windows Defender Event 1117: Antimalware platform performed action
-- Tracks successful threat remediation

return {
    metadata = {
        name = "defender.malware_blocked",
        category = "DEFENDER",
        severity = "INFO",
        recurrence = "RARE",
        description = "Windows Defender performed action to protect system",
        text_template = "[{timestamp}] Event {event_id}: Windows Defender performed action on malware. Name: {threat_name}, Action: {action_name}",
        tags = {"defender", "malware", "remediation"},
        merge_groups = {"defender_detections"}
    },

    generate = function(ctx, args)
        local threats_data = ctx.data.defender and ctx.data.defender.threat_names
        local all_threats = {}

        if threats_data then
            for category, threat_list in pairs(threats_data) do
                if type(threat_list) == "table" then
                    for _, threat in ipairs(threat_list) do
                        table.insert(all_threats, threat)
                    end
                end
            end
        end

        if #all_threats == 0 then
            all_threats = {"Trojan:Win32/Generic"}
        end

        local actions = {
            {id = 2, name = "Quarantine"},
            {id = 3, name = "Remove"},
            {id = 6, name = "Allow"}
        }
        local action = ctx.random.weighted_choice(actions, {0.6, 0.35, 0.05})

        return {
            event_id = 1117,
            provider_name = "Microsoft-Windows-Windows Defender",
            channel = "Microsoft-Windows-Windows Defender/Operational",
            computer = ctx.gen.windows_computer(),
            level = "Information",
            task_category = "None",
            keywords = "0x8000000000000000",

            threat_name = ctx.random.choice(all_threats),
            threat_id = ctx.random.int(100000, 999999),
            action_id = action.id,
            action_name = action.name,
            detection_user = ctx.gen.windows_domain() .. "\\" .. ctx.gen.windows_username(),

            description = "Windows Defender Antimalware platform performed an action to protect your system"
        }
    end
}
