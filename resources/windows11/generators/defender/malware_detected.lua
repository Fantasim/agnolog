-- Windows Defender Event 1116: Malware or unwanted software was detected
-- Critical security event

return {
    metadata = {
        name = "defender.malware_detected",
        category = "DEFENDER",
        severity = "ERROR",
        recurrence = "RARE",
        description = "Windows Defender detected malware or unwanted software",
        text_template = "[{timestamp}] Event {event_id}: Windows Defender Antimalware detected malware. Name: {threat_name}, Severity: {severity_name}, Path: {path}",
        tags = {"defender", "malware", "security", "antivirus"},
        merge_groups = {"defender_detections"}
    },

    generate = function(ctx, args)
        local threats_data = ctx.data.defender and ctx.data.defender.threat_names
        local all_threats = {}

        -- Flatten threat categories
        if threats_data then
            for category, threat_list in pairs(threats_data) do
                if type(threat_list) == "table" then
                    for _, threat in ipairs(threat_list) do
                        table.insert(all_threats, {name = threat, category = category})
                    end
                end
            end
        end

        -- Fallback threats
        if #all_threats == 0 then
            all_threats = {
                {name = "Trojan:Win32/Generic", category = "trojan"},
                {name = "Adware:Win32/Generic", category = "adware"}
            }
        end

        local threat = ctx.random.choice(all_threats)

        -- Severity levels (1=Low, 2=Medium, 4=High, 5=Severe)
        local severities = {
            {id = 1, name = "Low"},
            {id = 2, name = "Medium"},
            {id = 4, name = "High"},
            {id = 5, name = "Severe"}
        }
        local severity = ctx.random.weighted_choice(severities, {0.1, 0.3, 0.4, 0.2})

        -- Action taken
        local actions = {
            {id = 2, name = "Quarantine"},
            {id = 3, name = "Remove"},
            {id = 6, name = "Allow"},
            {id = 8, name = "User defined action"},
            {id = 9, name = "No action"}
        }
        local action = ctx.random.weighted_choice(actions, {0.5, 0.3, 0.05, 0.1, 0.05})

        -- File path
        local username = ctx.gen.windows_username()
        local paths = {
            "C:\\Users\\" .. username .. "\\Downloads\\setup.exe",
            "C:\\Users\\" .. username .. "\\AppData\\Local\\Temp\\tmp" .. ctx.gen.hex_string(8) .. ".exe",
            "C:\\Windows\\Temp\\install.tmp",
            "file:_C:\\Users\\" .. username .. "\\Downloads\\document.pdf",
            "C:\\Users\\" .. username .. "\\Desktop\\file.exe"
        }

        return {
            event_id = 1116,
            provider_name = "Microsoft-Windows-Windows Defender",
            channel = "Microsoft-Windows-Windows Defender/Operational",
            computer = ctx.gen.windows_computer(),
            level = "Warning",
            task_category = "None",
            keywords = "0x8000000000000000",

            threat_name = threat.name,
            threat_id = ctx.random.int(100000, 999999),
            threat_category = threat.category,
            severity_id = severity.id,
            severity_name = severity.name,
            category_id = ctx.random.int(0, 40),

            path = ctx.random.choice(paths),
            process_name = ctx.random.choice({
                "Unknown",
                "C:\\Windows\\Explorer.exe",
                "C:\\Program Files\\Internet Explorer\\iexplore.exe",
                "C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe",
                "C:\\Windows\\System32\\cmd.exe"
            }),

            detection_user = ctx.gen.windows_domain() .. "\\" .. username,
            action_id = action.id,
            action_name = action.name,

            description = "Windows Defender Antimalware has detected malware or other potentially unwanted software"
        }
    end
}
